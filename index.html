<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>星际主宰：音效与多级关卡版</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; transition: filter 0.3s; }
        #ui-layer { position: fixed; inset: 0; pointer-events: none; color: #0cf; padding: 20px; z-index: 10; text-shadow: 0 0 5px #0cf; }
        .stat-bar { width: 220px; height: 12px; border: 1px solid #0cf; margin: 5px 0; background: rgba(0,0,0,0.6); border-radius: 6px; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #f00, #ff4444); }
        #ult-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #f0f, #ff00ff); box-shadow: 0 0 15px #f0f; }
        #shop-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; color: #0cf; pointer-events: auto; }
        .shop-item { width: 340px; padding: 18px; margin: 10px; border: 1px solid #0cf; cursor: pointer; text-align: center; border-radius: 8px; transition: 0.2s; }
        .shop-item:hover { background: rgba(0,204,255,0.2); transform: scale(1.05); }
        #msg { position: fixed; top: 25%; width: 100%; text-align: center; color: #fff; font-size: 32px; font-weight: bold; pointer-events: none; text-shadow: 0 0 20px #0cf; }
        #level-info { position: fixed; top: 20px; right: 20px; text-align: right; font-size: 18px; }
        kbd { background: #333; padding: 2px 6px; border-radius: 4px; color: #eee; }
    </style>
</head>
<body>
    <div id="ui-layer">
        <div style="font-size: 22px; font-weight: bold;">得分: <span id="score">0</span></div>
        <div id="medals" style="font-size: 14px; opacity: 0.8;">历史最高: 0</div>
        <div id="level-info">当前关卡: <span id="cur-level">1</span><br><small id="level-name">星云边缘</small></div>
        <div style="color: gold; font-size: 18px; margin-top: 5px;">金币: <span id="coins">0</span></div>
        <div style="margin-top:15px;">战机装甲 (HP)</div>
        <div class="stat-bar"><div id="hp-fill"></div></div>
        <div style="margin-top:8px;">终极闪光能量 <kbd>X</kbd></div>
        <div class="stat-bar"><div id="ult-fill"></div></div>
    </div>

    <div id="shop-overlay">
        <h1 style="letter-spacing: 10px;">星际黑市</h1>
        <div id="shop-coins" style="color: gold; font-size: 24px; margin-bottom: 30px;">金币: 0</div>
        <div class="shop-item" onclick="buyUpgrade('hp')">纳米修复：恢复全部生命值 (200金)</div>
        <div class="shop-item" onclick="buyUpgrade('drone')">自动化模块：购买拦截僚机 (1000金)</div>
        <button onclick="toggleShop()" style="margin-top:30px; padding:12px 50px; background:#0cf; color:#000; border:none; font-weight:bold; cursor:pointer; border-radius:5px;">离开黑市</button>
    </div>

    <div id="msg"></div>

    <script src="node_modules/three/build/three.min.js"></script>
    <script src="node_modules/@tweenjs/tween.js/dist/tween.umd.js"></script>

    <script>
        // --- 1. 音效系统 (Web Audio API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'laser') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(110, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'explosion') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(1, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'levelUp') {
                [440, 554, 659].forEach((f, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    o.frequency.value = f;
                    g.gain.setValueAtTime(0.1, audioCtx.currentTime + i*0.1);
                    o.start(audioCtx.currentTime + i*0.1); o.stop(audioCtx.currentTime + i*0.1 + 0.2);
                });
            }
        }

        // --- 2. 场景与变量 ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(5, 10, 7); scene.add(dirLight);

        let score = 0, coins = 0, hp = 100, ultEnergy = 0, timeScale = 1.0, currentLevel = 1;
        let isShopOpen = false, isGameOver = false, hasDrone = false;
        const keys = {}, bullets = [], enemies = [], particles = [];

        // --- 3. 关卡配置 ---
        const levels = [
            { name: "星云边缘", scoreReq: 0, enemySpeed: 0.2, spawnRate: 1500, color: 0x00aaff },
            { name: "陨石带深处", scoreReq: 2000, enemySpeed: 0.3, spawnRate: 1000, color: 0xffaa00 },
            { name: "敌方要塞", scoreReq: 5000, enemySpeed: 0.45, spawnRate: 600, color: 0xff0044 }
        ];

        function checkLevel() {
            const nextLevel = levels.find((l, i) => i === currentLevel && score >= l.scoreReq);
            if (nextLevel) {
                currentLevel++;
                playSound('levelUp');
                document.getElementById('msg').innerText = "进入关卡: " + nextLevel.name;
                document.getElementById('cur-level').innerText = currentLevel;
                document.getElementById('level-name').innerText = nextLevel.name;
                scene.background = new THREE.Color(nextLevel.color).multiplyScalar(0.05);
                setTimeout(() => document.getElementById('msg').innerText = "", 3000);
            }
        }

        // --- 4. 3D 模型工厂 (简化高级版) ---
        function createPlayerShip() {
            const g = new THREE.Group();
            const m = new THREE.MeshPhongMaterial({color: 0x00aaff});
            const b = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.7, 3, 8), m);
            b.rotation.x = Math.PI/2; g.add(b);
            const w = new THREE.Mesh(new THREE.BoxGeometry(4, 0.1, 1), m); g.add(w);
            const fire = new THREE.Mesh(new THREE.ConeGeometry(0.3, 1, 8), new THREE.MeshBasicMaterial({color:0x00ffff}));
            fire.position.z = 2; fire.rotation.x = -Math.PI/2; g.add(fire);
            g.userData.fire = fire; return g;
        }

        const player = createPlayerShip(); scene.add(player);
        camera.position.set(0, 12, 18); camera.lookAt(0,0,0);

        // --- 5. 核心循环 ---
        window.addEventListener('keydown', e => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            keys[e.code] = true;
            if(e.code === 'Space') { shoot(); playSound('laser'); }
            if(e.code === 'KeyB') toggleShop();
        });
        window.addEventListener('keyup', e => keys[e.code] = false);

        function shoot() {
            const b = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({color:0xff0000}));
            b.position.copy(player.position); scene.add(b); bullets.push(b);
        }

        function spawnEnemy() {
            if(isGameOver || isShopOpen) return;
            const cfg = levels[currentLevel-1];
            const en = new THREE.Mesh(new THREE.OctahedronGeometry(1.2), new THREE.MeshPhongMaterial({color:0xff3300}));
            en.position.set(Math.random()*40-20, 0, -50);
            scene.add(en); enemies.push(en);
        }
        let spawnTimer = setInterval(spawnEnemy, levels[0].spawnRate);

        function updateUI() {
            document.getElementById('score').innerText = score;
            document.getElementById('coins').innerText = coins;
            document.getElementById('hp-fill').style.width = hp + "%";
            document.getElementById('ult-fill').style.width = ultEnergy + "%";
            checkLevel();
        }

        function toggleShop() { isShopOpen = !isShopOpen; document.getElementById('shop-overlay').style.display = isShopOpen ? 'flex' : 'none'; }

        function animate(time) {
            requestAnimationFrame(animate);
            if(isGameOver || isShopOpen) return;
            
            // 移动
            if(keys['KeyA']) player.position.x -= 0.3;
            if(keys['KeyD']) player.position.x += 0.3;
            if(keys['KeyW']) player.position.z -= 0.3;
            if(keys['KeyS']) player.position.z += 0.3;

            // 引擎效果
            player.userData.fire.scale.set(1, 1+Math.sin(time*0.01)*0.5, 1);

            // 逻辑更新
            const cfg = levels[currentLevel-1];
            bullets.forEach((b, bi) => {
                b.position.z -= 0.8;
                enemies.forEach((en, ei) => {
                    if(b.position.distanceTo(en.position) < 2) {
                        playSound('explosion');
                        scene.remove(en); enemies.splice(ei, 1);
                        scene.remove(b); bullets.splice(bi, 1);
                        score += 100; coins += 50; updateUI();
                    }
                });
            });

            enemies.forEach((en, ei) => {
                en.position.z += cfg.enemySpeed;
                if(en.position.distanceTo(player.position) < 2) {
                    hp -= 20; updateUI(); scene.remove(en); enemies.splice(ei, 1);
                    if(hp <= 0) { alert("战机毁于关卡 " + currentLevel); location.reload(); }
                }
            });

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
</html>

