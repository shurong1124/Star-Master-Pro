<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Star Dominator: Quantum Evolution</title>
    <style>
        :root { --main: #00f2ff; --warn: #ff3c3c; --acc: #f700ff; --gold: #ffd700; --shield: #0088ff; --bg: #050a10; }
        body { margin: 0; background: var(--bg); overflow: hidden; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; color: white; }
        
        /* ÁïåÈù¢ÈÄöÁî®Ê†∑Âºè */
        .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); }
        .btn { background: transparent; border: 2px solid var(--main); color: var(--main); padding: 12px 25px; cursor: pointer; font-weight: bold; font-size: 18px; border-radius: 5px; margin: 10px; transition: 0.3s; }
        .btn:hover { background: var(--main); color: #000; box-shadow: 0 0 20px var(--main); }
        .panel { display: none; width: 90%; max-width: 1000px; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 15px; border: 1px solid #333; }

        /* ÊàòÊñó GUI */
        #gui { position: fixed; inset: 0; pointer-events: none; padding: 25px; display: none; z-index: 10; }
        .status-bar { position: fixed; top: 20px; left: 20px; text-align: left; }
        #boss-ui { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); width: 60%; display: none; text-align: center; }
        .hp-outer { width: 100%; height: 12px; background: #300; border: 1px solid #f00; border-radius: 6px; overflow: hidden; }
        #boss-hp-fill { width: 100%; height: 100%; background: #f00; transition: width 0.2s; }
        
        /* Â∫ïÈÉ®ÊéßÂà∂Ê†è */
        .bottom-ctrl { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; pointer-events: auto; }
        .skill-btn { width: 65px; height: 65px; border: 2px solid #444; border-radius: 12px; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .skill-btn.active { border-color: var(--main); box-shadow: 0 0 15px var(--main); }
        
        /* Ê∂àÊÅØÊèêÁ§∫ */
        #msg { position: fixed; top: 40%; width: 100%; text-align: center; font-size: 50px; font-weight: 900; opacity: 0; transition: 0.5s; pointer-events: none; z-index: 2000; }
        
        /* Â§©ËµãÊ†ë‰∏éÂÆûÈ™åÂÆ§Â∏ÉÂ±Ä */
        .flex-row { display: flex; gap: 20px; margin-top: 20px; }
        .card { flex: 1; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; border: 1px solid #444; text-align: center; }
        input[type=range] { width: 100%; }
    </style>
</head>
<body>

<div id="lang-select" class="overlay">
    <h1 style="color: var(--main); margin-bottom: 40px; letter-spacing: 5px;">SELECT LANGUAGE / ÈÄâÊã©ËØ≠Ë®Ä</h1>
    <div style="display: flex;">
        <button class="btn" onclick="game.init('zh')">‰∏≠Êñá (ÁÆÄ‰Ωì)</button>
        <button class="btn" onclick="game.init('en')">ENGLISH</button>
    </div>
</div>

<div id="lobby" class="overlay" style="display:none;">
    <h1 id="t-title" style="color: var(--main); letter-spacing: 10px; font-size: 48px; margin-bottom: 5px;">STAR DOMINATOR</h1>
    <div style="color: var(--gold); margin-bottom: 30px;"><span id="t-money">CREDITS</span>: <span id="wallet">0</span></div>
    
    <div style="display: flex; gap: 15px;">
        <button class="btn" onclick="game.startMission()" id="t-start">START MISSION</button>
        <button class="btn" onclick="game.showPanel('talents')" id="t-btn-talent">TECH TREE</button>
        <button class="btn" onclick="game.showPanel('lab')" id="t-btn-lab">LAB</button>
    </div>

    <div id="panel-talents" class="panel">
        <h2 id="t-talent-title">Quantum Tech Tree</h2>
        <div class="flex-row" id="talent-list"></div>
        <button class="btn" onclick="game.hidePanels()">CLOSE</button>
    </div>

    <div id="panel-lab" class="panel">
        <h2 id="t-lab-title">Visual Lab</h2>
        <div class="flex-row">
            <div class="card">
                <label id="t-lab-hue">Hull Hue</label><br>
                <input type="range" id="edit-color" min="0" max="360" value="180" oninput="game.updateLabPreview()">
                <label id="t-lab-width">Wing Width</label><br>
                <input type="range" id="edit-width" min="0.5" max="2.5" step="0.1" value="1" oninput="game.updateLabPreview()">
            </div>
            <div class="card">
                <h4 id="t-affix-title">Random Affixes</h4>
                <div id="affix-display" style="color: var(--gold); margin: 10px 0; font-size: 14px;">None</div>
                <button class="btn" onclick="game.refineAffixes()" style="font-size: 12px;" id="t-btn-refine">REFINE (500c)</button>
            </div>
        </div>
        <button class="btn" onclick="game.hidePanels()">SAVE & CLOSE</button>
    </div>
</div>

<div id="gui">
    <div id="boss-ui">
        <div id="t-boss-name" style="color: red; font-weight: bold; font-size: 14px;">BOSS</div>
        <div class="hp-outer"><div id="boss-hp-fill"></div></div>
    </div>
    <div class="status-bar">
        <div id="score-display" style="font-size: 32px; font-weight: 900; color: var(--main);">0</div>
        <div style="width: 200px; height: 10px; background: #222; border: 1px solid #444; margin-top: 5px;">
            <div id="hp-bar" style="width: 100%; height: 100%; background: var(--warn); transition: 0.2s;"></div>
        </div>
    </div>
    <div id="weapon-name" style="position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%); color: var(--gold); font-weight: bold;">WEAPON: BALANCED</div>
    <div class="bottom-ctrl">
        <div class="skill-btn" onclick="game.switchWeapon()"><span style="font-size: 24px;">‚öîÔ∏è</span><small>[Q]</small></div>
        <div class="skill-btn" id="btn-shield" onclick="game.triggerShield()">
            <div id="shield-fill" style="position:absolute; bottom:0; width:100%; background:var(--shield); opacity:0.5; height:100%;"></div>
            <span style="font-size: 24px; z-index: 1;">üõ°Ô∏è</span><small style="z-index: 1;">[SPACE]</small>
        </div>
    </div>
</div>

<div id="msg"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
const I18N = {
    zh: {
        title: "ÊòüÈôÖ‰∏ªÂÆ∞", money: "ÂÇ®Â§áËµÑÈáë", start: "ÂºÄÂßãÂá∫Âáª", btnT: "ÁßëÊäÄÊ†ë", btnL: "ÂÆûÈ™åÂÆ§",
        t_title: "ÈáèÂ≠êÁßëÊäÄÂº∫Âåñ", l_title: "Â§ñËßÇÂÆûÈ™åÂÆ§", l_hue: "Êú∫Ë∫´Ê∂ÇË£Ö", l_width: "Êú∫ÁøºÂÆΩÂ∫¶",
        refine: "ÈöèÊú∫Ê¥óÁÇº (500c)", affix_t: "ÂΩìÂâçÂ±ûÊÄßËØçÊù°", boss: "Â∏ùÂõΩË£ÅÂÜ≥ËÄÖ - Ê≠ºÊòüÁ∫ßÊØçËà∞",
        hp: "Êú∫‰ΩìË£ÖÁî≤", weapon: "ÂΩìÂâçÊ≠¶Âô®: ", score: "ÁßØÂàÜ: ",
        w_names: ["Âπ≥Ë°°", "Êï£Â∞Ñ", "ÈáçÁÇÆ"],
        msgs: ["Ë≠¶Âëä: Ê£ÄÊµãÂà∞Â∑®ÂûãËÉΩÈáèÊ∫ê!", "‰ªªÂä°ÊàêÂäü!", "ÊàòÊú∫ÊçüÊØÅ!", "Êä§ÁõæÂ∑≤ÂºÄÂêØ"]
    },
    en: {
        title: "STAR DOMINATOR", money: "CREDITS", start: "START MISSION", btnT: "TECH TREE", btnL: "LAB",
        t_title: "Quantum Technology", l_title: "Visual Laboratory", l_hue: "Hull Painting", l_width: "Wing Span",
        refine: "REFINE (500c)", affix_t: "Current Affixes", boss: "IMPERIAL JUDGE - STAR DESTROYER",
        hp: "HULL INTEGRITY", weapon: "WEAPON: ", score: "SCORE: ",
        w_names: ["BALANCED", "SPREAD", "HEAVY"],
        msgs: ["WARNING: MASSIVE SIGNATURE!", "MISSION SUCCESS!", "SHIP DESTROYED!", "SHIELD ACTIVE"]
    }
};

class StarEngine {
    constructor() {
        this.data = JSON.parse(localStorage.getItem('star_master_data')) || {
            wallet: 1000, talents: { atk: 0, def: 0 }, visuals: { hue: 180, width: 1 }, affixes: []
        };
        this.lang = 'en';
        this.state = { active: false, score: 0, hp: 100, weaponMode: 0, shieldActive: false, shieldCD: false };
        this.bullets = []; this.enemies = []; this.terrains = []; this.ebullets = []; this.keys = {};
    }

    init(lang) {
        this.lang = lang;
        document.getElementById('lang-select').style.display = 'none';
        document.getElementById('lobby').style.display = 'flex';
        this.applyI18N();
        this.initThree();
        this.updateUI();
    }

    applyI18N() {
        const t = I18N[this.lang];
        document.getElementById('t-title').innerText = t.title;
        document.getElementById('t-money').innerText = t.money;
        document.getElementById('t-start').innerText = t.start;
        document.getElementById('t-btn-talent').innerText = t.btnT;
        document.getElementById('t-btn-lab').innerText = t.btnL;
        document.getElementById('t-talent-title').innerText = t.t_title;
        document.getElementById('t-lab-title').innerText = t.l_title;
        document.getElementById('t-lab-hue').innerText = t.l_hue;
        document.getElementById('t-lab-width').innerText = t.l_width;
        document.getElementById('t-btn-refine').innerText = t.refine;
        document.getElementById('t-affix-title').innerText = t.affix_t;
        document.getElementById('t-boss-name').innerText = t.boss;
        this.updateWeaponUI();
    }

    updateUI() {
        document.getElementById('wallet').innerText = this.data.wallet;
        document.getElementById('affix-display').innerHTML = this.data.affixes.length > 0 ? 
            this.data.affixes.map(a => `<div>‚Ä¢ ${a}</div>`).join('') : "None";
    }

    showPanel(id) {
        this.hidePanels();
        document.getElementById('panel-' + id).style.display = 'block';
    }

    hidePanels() {
        document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
        this.save();
    }

    refineAffixes() {
        if(this.data.wallet < 500) return;
        this.data.wallet -= 500;
        const pool = ["Crit +20%", "Haste +15%", "Shield+2s", "Double Drop", "Pierce Shot"];
        this.data.affixes = [pool[Math.floor(Math.random()*pool.length)], pool[Math.floor(Math.random()*pool.length)]];
        this.updateUI();
    }

    updateLabPreview() {
        this.data.visuals.hue = document.getElementById('edit-color').value;
        this.data.visuals.width = document.getElementById('edit-width').value;
        const c = new THREE.Color(`hsl(${this.data.visuals.hue}, 100%, 50%)`);
        this.player.material.color.set(c);
        this.player.scale.set(this.data.visuals.width, 1, 1);
    }

    switchWeapon() {
        this.state.weaponMode = (this.state.weaponMode + 1) % 3;
        this.updateWeaponUI();
    }

    updateWeaponUI() {
        const w = I18N[this.lang].w_names[this.state.weaponMode];
        document.getElementById('weapon-name').innerText = I18N[this.lang].weapon + w;
    }

    triggerShield() {
        if(this.state.shieldCD || !this.state.active) return;
        this.state.shieldActive = true;
        this.shieldMesh.visible = true;
        this.showMessage(I18N[this.lang].msgs[3]);
        setTimeout(() => {
            this.state.shieldActive = false;
            this.shieldMesh.visible = false;
            this.state.shieldCD = true;
            this.startShieldTimer();
        }, 4000);
    }

    startShieldTimer() {
        let p = 0;
        const inv = setInterval(() => {
            p += 2;
            document.getElementById('shield-fill').style.height = p + "%";
            if(p >= 100) { clearInterval(inv); this.state.shieldCD = false; }
        }, 200);
    }

    spawnBoss() {
        this.state.bossActive = true;
        this.state.bossHp = 4000;
        document.getElementById('boss-ui').style.display = 'block';
        this.showMessage(I18N[this.lang].msgs[0]);
        this.boss = new THREE.Mesh(new THREE.BoxGeometry(25, 6, 12), new THREE.MeshPhongMaterial({color: 0x333333}));
        this.boss.position.set(0, 0, -100);
        this.scene.add(this.boss);
    }

    showMessage(t) {
        const m = document.getElementById('msg');
        m.innerText = t; m.style.opacity = 1;
        setTimeout(() => m.style.opacity = 0, 2000);
    }

    startMission() {
        this.state.active = true;
        this.state.hp = 100;
        this.state.score = 0;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('gui').style.display = 'block';
        this.updateLabPreview();
        
        this.spawnInt = setInterval(() => { if(!this.state.bossActive) this.spawnEnemy(); }, 1200);
        this.obsInt = setInterval(() => this.spawnObstacle(), 4000);
        setTimeout(() => this.spawnBoss(), 15000);
        this.loop();
    }

    spawnEnemy() {
        const e = new THREE.Mesh(new THREE.OctahedronGeometry(1.5), new THREE.MeshPhongMaterial({color: 0xff3333}));
        e.position.set((Math.random()-0.5)*50, 0, -80);
        this.scene.add(e); this.enemies.push(e);
    }

    spawnObstacle() {
        const o = new THREE.Mesh(new THREE.IcosahedronGeometry(Math.random()*4+2), new THREE.MeshPhongMaterial({color: 0x666666}));
        o.position.set((Math.random()-0.5)*50, 0, -90);
        this.scene.add(o); this.terrains.push(o);
    }

    fire() {
        const now = Date.now();
        const rates = [200, 400, 700];
        if(now - (this.lastShot||0) < rates[this.state.weaponMode]) return;
        this.lastShot = now;

        const makeB = (offX = 0, size = 0.3) => {
            const b = new THREE.Mesh(new THREE.SphereGeometry(size), new THREE.MeshBasicMaterial({color: 0x00f2ff}));
            b.position.copy(this.player.position);
            b.position.x += offX;
            b.userData = { damage: size * 100 };
            this.scene.add(b); this.bullets.push(b);
        };

        if(this.state.weaponMode === 0) makeB();
        else if(this.state.weaponMode === 1) { makeB(-1.5); makeB(0); makeB(1.5); }
        else { makeB(0, 1.2); }
    }

    loop() {
        if(!this.state.active) return;
        requestAnimationFrame(() => this.loop());

        if(this.keys['KeyA']) this.player.position.x -= 0.7;
        if(this.keys['KeyD']) this.player.position.x += 0.7;
        if(this.keys['KeyQ']) { /* Handled in event */ }
        if(this.keys['Space']) { /* Handled in event */ }
        this.player.position.x = THREE.MathUtils.clamp(this.player.position.x, -25, 25);
        this.shieldMesh.position.copy(this.player.position);

        this.fire();

        // Â≠êÂºπÁßªÂä®‰∏éÁ¢∞Êíû
        this.bullets.forEach((b, i) => {
            b.position.z -= 2;
            if(b.position.z < -100) { this.scene.remove(b); this.bullets.splice(i, 1); return; }
            
            if(this.state.bossActive && b.position.distanceTo(this.boss.position) < 10) {
                this.state.bossHp -= b.userData.damage;
                this.scene.remove(b); this.bullets.splice(i, 1);
            }
        });

        // Êïå‰∫∫ÁßªÂä®
        this.enemies.forEach((e, i) => {
            e.position.z += 0.8;
            if(e.position.distanceTo(this.player.position) < 3) {
                if(!this.state.shieldActive) this.state.hp -= 20;
                this.scene.remove(e); this.enemies.splice(i, 1);
            }
        });

        // Âú∞ÂΩ¢ÁßªÂä®
        this.terrains.forEach((o, i) => {
            o.position.z += 0.4;
            if(o.position.distanceTo(this.player.position) < 4 && !this.state.shieldActive) this.state.hp -= 0.5;
        });

        // BOSS ÈÄªËæë
        if(this.state.bossActive) {
            this.boss.position.x = Math.sin(Date.now()/1000) * 15;
            this.boss.position.z = -40 + Math.cos(Date.now()/1500) * 5;
            document.getElementById('boss-hp-fill').style.width = (this.state.bossHp/4000*100) + "%";
            if(this.state.bossHp <= 0) {
                this.showMessage(I18N[this.lang].msgs[1]);
                this.data.wallet += 2000;
                setTimeout(() => location.reload(), 3000);
            }
        }

        document.getElementById('score-display').innerText = I18N[this.lang].score + this.state.score;
        document.getElementById('hp-bar').style.width = this.state.hp + "%";
        if(this.state.hp <= 0) {
            this.showMessage(I18N[this.lang].msgs[2]);
            setTimeout(() => location.reload(), 2000);
        }

        this.renderer.render(this.scene, this.camera);
    }

    initThree() {
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        this.renderer = new THREE.WebGLRenderer({ antialias: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(this.renderer.domElement);
        this.camera.position.set(0, 25, 25); this.camera.lookAt(0,0,-10);
        this.scene.add(new THREE.AmbientLight(0xffffff, 0.4), new THREE.DirectionalLight(0x00f2ff, 1));
        
        this.player = new THREE.Mesh(new THREE.ConeGeometry(1.2, 4, 4), new THREE.MeshPhongMaterial({color: 0x00f2ff}));
        this.player.rotation.x = -Math.PI/2;
        this.scene.add(this.player);

        this.shieldMesh = new THREE.Mesh(new THREE.SphereGeometry(3.5, 16, 16), new THREE.MeshBasicMaterial({color: 0x0088ff, wireframe: true, transparent: true, opacity: 0.3}));
        this.shieldMesh.visible = false;
        this.scene.add(this.shieldMesh);

        window.onkeydown = e => { this.keys[e.code] = true; if(e.code === 'KeyQ') this.switchWeapon(); if(e.code === 'Space') this.triggerShield(); };
        window.onkeyup = e => { this.keys[e.code] = false; };
    }

    save() { localStorage.setItem('star_master_data', JSON.stringify(this.data)); }
}

const game = new StarEngine();
</script>
</body>
</html>
